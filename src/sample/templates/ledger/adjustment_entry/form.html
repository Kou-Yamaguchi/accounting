{% extends "base.html" %}
{% load static %}
{% load django_bootstrap5 %}

{% block main %}

<head>
  <script src="{% static 'javascript/je_form.js' %}"></script>
</head>

<h2>決算整理仕訳入力</h2>

<!-- 会計期間選択フォーム（別フォーム） -->
{% if not fiscal_period %}
<div class="alert alert-info">
  <h4>会計期間を選択してください</h4>
  <form method="get" action="">
    <div class="row">
      <div class="col-md-6">
        <select name="fiscal_period" class="form-control" onchange="this.form.submit()">
          <option value="">-- 会計期間を選択 --</option>
          {% for period in form.fields.fiscal_period.queryset %}
            <option value="{{ period.id }}">{{ period.name }} ({{ period.start_date }} 〜 {{ period.end_date }})</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </form>
</div>
{% endif %}

<!-- 会計期間が選択されている場合のみ仕訳入力フォームと参考情報を表示 -->
{% if fiscal_period %}

<!-- 参考情報の表示 -->
<div class="reference-info mt-4 mb-4">
  <div class="card">
    <div class="card-header">
      <h3>決算整理仕訳 参考情報</h3>
      <p class="mb-0">会計期間: <strong>{{ fiscal_period.name }}</strong> ({{ fiscal_period.start_date }} 〜 {{ fiscal_period.end_date }})</p>
    </div>
    <div class="card-body">
      <!-- 減価償却費の参考情報 -->
      {% if depreciation %}
      <div class="depreciation-info mb-4">
        <h4>減価償却費</h4>
        {% if depreciation.assets %}
        <table class="table table-sm table-bordered">
          <thead>
            <tr>
              <th>資産番号</th>
              <th>資産名</th>
              <th>勘定科目</th>
              <th>取得価額</th>
              <th>耐用年数</th>
              <th>当期償却額</th>
              <th>減価償却累計額</th>
              <th>帳簿価額</th>
              <th>状態</th>
            </tr>
          </thead>
          <tbody>
            {% for asset in depreciation.assets %}
            <tr {% if asset.already_recorded %}class="table-secondary"{% endif %}>
              <td>{{ asset.asset_number }}</td>
              <td>{{ asset.asset_name }}</td>
              <td>{{ asset.account_name }}</td>
              <td class="text-end">{{ asset.acquisition_cost|floatformat:0 }}</td>
              <td class="text-end">{{ asset.useful_life }}年</td>
              <td class="text-end">{{ asset.current_period_depreciation|floatformat:0 }}</td>
              <td class="text-end">{{ asset.accumulated_depreciation_with_current|floatformat:0 }}</td>
              <td class="text-end">{{ asset.book_value|floatformat:0 }}</td>
              <td>
                {% if asset.already_recorded %}
                  <span class="badge bg-success">計上済</span>
                {% else %}
                  <span class="badge bg-warning">未計上</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
            <tr class="table-primary fw-bold">
              <td colspan="5" class="text-end">合計</td>
              <td class="text-end">{{ depreciation.total_depreciation|floatformat:0 }}</td>
              <td colspan="3"></td>
            </tr>
          </tbody>
        </table>
        {% if depreciation.has_unrecorded %}
        <div class="alert alert-warning">
          <strong>未計上の減価償却費があります。</strong> 決算整理仕訳を入力してください。
        </div>
        {% endif %}
        {% else %}
        <p class="text-muted">固定資産が登録されていません。</p>
        {% endif %}
      </div>
      {% endif %}

      <!-- 貸倒引当金の参考情報 -->
      {% if allowance %}
      <div class="allowance-info mb-4">
        <h4>貸倒引当金</h4>
        {% if allowance.total_receivables > 0 %}
        <table class="table table-sm table-bordered">
          <thead>
            <tr>
              <th>勘定科目</th>
              <th>残高</th>
            </tr>
          </thead>
          <tbody>
            {% for account in allowance.receivables_accounts %}
            <tr>
              <td>{{ account.account_name }}</td>
              <td class="text-end">{{ account.balance|floatformat:0 }}</td>
            </tr>
            {% endfor %}
            <tr class="table-primary fw-bold">
              <td>合計</td>
              <td class="text-end">{{ allowance.total_receivables|floatformat:0 }}</td>
            </tr>
          </tbody>
        </table>
        <div class="calculation-detail">
          <p><strong>引当率:</strong> {{ allowance.allowance_rate|floatformat:2 }}%</p>
          <p><strong>必要引当金額:</strong> {{ allowance.required_allowance|floatformat:0 }}円</p>
          <p><strong>前期引当金残高:</strong> {{ allowance.previous_allowance|floatformat:0 }}円</p>
          <p class="fw-bold">
            <strong>
              {% if allowance.is_reversal %}
                貸倒引当金戻入額:
              {% else %}
                貸倒引当金繰入額:
              {% endif %}
            </strong> {{ allowance.entry_amount|floatformat:0 }}円
          </p>
        </div>
        {% else %}
        <p class="text-muted">売掛金等の債権がありません。</p>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- 仕訳入力フォーム -->
<form method="post">
  {% csrf_token %}

  <h3>決算整理仕訳</h3>
  
  <!-- 会計期間と日付情報 -->
  <input type="hidden" name="fiscal_period" value="{{ fiscal_period.id }}">
  <div class="alert alert-info">
    <p class="mb-0">
      <strong>会計期間:</strong> {{ fiscal_period.name }}<br>
      <strong>仕訳日付:</strong> {{ fiscal_period.end_date }} (期末日で自動設定)
    </p>
  </div>

  {% bootstrap_form form %}
  {{ form.errors }}

  <h3>仕訳明細</h3>
  <div class="table-responsive">
    <table class="table table-bordered" id="journal-entry-table">
      <thead>
        <tr>
          <th>勘定科目(借方)</th>
          <th>金額(借方)</th>
          <th style="width: 80px;"></th>
          <th>勘定科目(貸方)</th>
          <th>金額(貸方)</th>
          <th style="width: 80px;"></th>
        </tr>
      </thead>
      <tbody id="journal-entry-tbody">
        {{ debit_formset.management_form }}
        {{ credit_formset.management_form }}
      </tbody>
    </table>
  </div>
  
  <!-- 非表示のテンプレート -->
  <div style="display:none;" id="formset-templates">
    <div id="debit-template">
      {{ debit_formset.empty_form.as_p }}
    </div>
    <div id="credit-template">
      {{ credit_formset.empty_form.as_p }}
    </div>
  </div>
  
  <div id="existing-forms" style="display: none;">
    {% for form in debit_formset %}
    {{ form.as_p }}
    {% endfor %}
    {% for form in credit_formset %}
    {{ form.as_p }}
    {% endfor %}
  </div>
  <div class="mb-3">
    <button type="button" class="btn btn-primary me-2" id="add-debit-button">借方行を追加</button>
    <button type="button" class="btn btn-primary" id="add-credit-button">貸方行を追加</button>
  </div>



  <!-- <div class="journal-lines"> -->
    <!-- <div id="debit-lines-container"> -->
      <!-- <h4>借方行</h4> -->
      <!-- {{ debit_formset.management_form }} -->
      <!-- {% for debit_form in debit_formset %} -->
      <!-- <div class="journal-line"> -->
        <!-- {% bootstrap_form debit_form %} -->
        <!-- <button type="button" class="remove-line-button">行を削除</button> -->
      <!-- </div> -->
      <!-- {% endfor %} -->

      <!-- <div class="empty-form-template" style="display:none;"> -->
        <!-- {% bootstrap_form debit_formset.empty_form %} -->
      <!-- </div> -->

      <!-- {% bootstrap_button button_type="button" content="借方を追加" id="add-debit-button" %} -->
    <!-- </div> -->

    <!-- <div id="credit-lines-container"> -->
      <!-- <h4>貸方行</h4> -->
      <!-- {{ credit_formset.management_form }} -->
      <!-- {% for credit_form in credit_formset %} -->
      <!-- <div class="journal-line"> -->
        <!-- {% bootstrap_form credit_form %} -->
        <!-- <button type="button" class="remove-line-button">行を削除</button> -->
      <!-- </div> -->
      <!-- {% endfor %} -->

      <!-- <div class="empty-form-template" style="display:none;"> -->
        <!-- {% bootstrap_form credit_formset.empty_form %} -->
      <!-- </div> -->

      <!-- {% bootstrap_button button_type="button" content="貸方を追加" id="add-credit-button" %} -->
    <!-- </div> -->
  <!-- </div> -->

  {% bootstrap_button button_type="submit" content="保存" %}
  <a href="{% url 'journal_entry_list' %}" class="btn btn-secondary">キャンセル</a>
</form>

{% endif %}

{% endblock %}