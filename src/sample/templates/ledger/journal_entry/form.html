{% extends "base.html" %}
{% load static %}
{% load django_bootstrap5 %}

{% block main %}

<head>
  <script src="{% static 'javascript/je_form.js' %}"></script>
</head>

<h2>仕訳登録・編集</h2>
<form method="post">
  {% csrf_token %}

  <h2>ヘッダー情報</h2>
  {% bootstrap_form form %}
  
  {% if form.errors %}
  <div class="alert alert-danger" role="alert">
    <strong>ヘッダー情報のエラー:</strong>
    {{ form.errors }}
  </div>
  {% endif %}

  <h3>仕訳明細</h3>
  
  <!-- フォームセット全体のエラー表示（借貸不一致など） -->
  {% if debit_formset.non_form_errors or credit_formset.non_form_errors %}
  <div class="alert alert-danger" role="alert">
    <strong>仕訳明細のエラー:</strong>
    {% if debit_formset.non_form_errors %}
    <div class="mb-2">
      <strong>借方:</strong>
      <ul class="mb-0">
        {% for error in debit_formset.non_form_errors %}
        <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
    {% if credit_formset.non_form_errors %}
    <div>
      <strong>貸方:</strong>
      <ul class="mb-0">
        {% for error in credit_formset.non_form_errors %}
        <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
  </div>
  {% endif %}
  
  <div class="table-responsive">
    <table class="table table-bordered" id="journal-entry-table">
      <thead>
        <tr>
          <th>勘定科目(借方)</th>
          <th>金額(借方)</th>
          <th style="width: 80px;"></th>
          <th>勘定科目(貸方)</th>
          <th>金額(貸方)</th>
          <th style="width: 80px;"></th>
        </tr>
      </thead>
      <tbody id="journal-entry-tbody">
        {{ debit_formset.management_form }}
        {{ credit_formset.management_form }}
      </tbody>
    </table>
  </div>

  <!-- 非表示のテンプレート -->
  <div style="display:none;" id="formset-templates">
    <div id="debit-template">
      {{ debit_formset.empty_form.as_p }}
    </div>
    <div id="credit-template">
      {{ credit_formset.empty_form.as_p }}
    </div>
  </div>

  <div id="existing-forms" style="display: none;">
    {% for form in debit_formset %}
      {{ form.as_p }}
    {% endfor %}
    {% for form in credit_formset %}
      {{ form.as_p }}
    {% endfor %}
  </div>
  <div class="mb-3">
    <button type="button" class="btn btn-primary me-2" id="add-debit-button">借方行を追加</button>
    <button type="button" class="btn btn-primary" id="add-credit-button">貸方行を追加</button>
  </div>

  <!-- 固定資産登録フォーム -->
  <div class="fixed-asset-section mt-4">
    <h3>固定資産登録（オプション）</h3>
    <div class="card">
      <div class="card-body">
        <div class="form-check mb-3">
          {{ fixed_asset_form.register_as_fixed_asset }}
          <label class="form-check-label" for="{{ fixed_asset_form.register_as_fixed_asset.id_for_label }}">
            {{ fixed_asset_form.register_as_fixed_asset.label }}
          </label>
        </div>

        <div id="fixed-asset-details" style="display: none;">
          {% for field in fixed_asset_form %}
          {% if field.name != 'register_as_fixed_asset' %}
          {% bootstrap_field field %}
          {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  {% bootstrap_button button_type="submit" content="保存" %}
</form>

{% endblock %}
